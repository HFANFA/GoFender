alert http $HOME_NET any -> $EXTERNAL_NET 80 (msg: "[MALWARE] Pegasus (Buhtrap/Ratopak) C2 connection"; flow: established, to_server; content: "POST"; http_method; content: ".php"; http_uri; content: "Content-Type: multipart/form-data|3b| boundary="; http_header; pcre: "/^[0-9a-f]{12}\r\n/RH"; content: "Content-Type: application/octet-stream"; http_client_body; content: "Content-Disposition: form-data|3b| name=|22|"; http_client_body; pcre: "/^[a-z]{8,14}\x22\r\nContent-Type: application/octet-stream\r\n\r\n(.{192}){1,2}\r\n--[0-9a-z]{12}--/RPs"; pcre: "/[\x0e-\x19\x80-\xff]{4}/P"; classtype: trojan-activity; reference: url, github.com/ptresearch/AttackDetection; sid: 10003298; rev: 1; )

alert udp $HOME_NET any -> $HOME_NET 138 (msg: "[MALWARE] Pegasus (Buhtrap/Ratopak) credentials broadcast via Mailslot"; content: "|5C|MAILSLOT|5C|"; content: !"|00|"; within: 16; pcre: "/^[0-9A-F]{16,32}\x00/R"; pcre: "/[\x0e-\x19\x80-\xff]{5}/R"; threshold: type both, track by_src, count 4, seconds 3600; classtype: trojan-activity; reference: url, github.com/ptresearch/AttackDetection; sid: 10003304; rev: 1; )

alert tcp $HOME_NET any -> $HOME_NET 445 (msg: "[MALWARE] Pegasus (Buhtrap/Ratopak) domain replication remote pipe check"; flow: established, to_server, no_stream; content: "SMB"; content: "|0B 00|"; distance: 8; within: 2; content: "|00 00 18 00 11 00 FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF FF|"; distance: 0; pcre: "/([0-9A-F]\x00){16,32}$/R"; threshold: type threshold, track by_src, count 8, seconds 2; classtype: trojan-activity; reference: url, github.com/ptresearch/AttackDetection; sid: 10003305; rev: 1; )

